#define TASKABLE
#include "AllHead.h"
bool NoUseNum=FALSE;
u8 AlarmCount=4;//2G3G切换计数,默认为3G模式
u8 NetworkType_2Gor3G_Flag=3;
u8 PersonCallIco_Flag=0;//根据显示组呼个呼图标判断状态
#if 1 //test
u8 Key_PersonalCalling_Flag=0;
bool TASK_Ptt_StartPersonCalling_Flag=FALSE;
bool Task_Landing_Flag=FALSE;
u8 KeyCount_PersonalCalling=0;
u8 EnterPttMomentCount=0;
u8 LoosenPttMomentCount=0;
bool EnterPttMoment_Flag=FALSE;
bool LoosenPttMoment_Flag=FALSE;
bool EnterKeyTime_2s_Flag=FALSE;
#endif

u8 *ucStartPTT                  = "0B0000";
u8 *ucEndPTT                    = "0C0000";
u8 *ucRequestUserListInfo       = "0E000000000064";
u8 *ucCLVL                       = "AT+CLVL=7";//音量增益7
u8 *ucVGR                       = "AT+VGR=7";//音量增益7
u8 *ucCODECCTL                  = "at^codecctl=9000,1c00,0";//音量增益4000 3c00

u8 *ucOSSYSHWID                 = "AT^OSSYSHWID=1";
u8 *ucPrefmode2                  = "AT^prefmode=2";//网络模式2G
u8 *ucPrefmode4                  = "AT^prefmode=4";//网络模式3G
u8 *ucPrefmode8                  = "AT^prefmode=8";//网络模式2/3G自动切换
u8 *ucCSQ                       = "AT+CSQ?";
u8 *ucPPPCFG                    = "AT^PPPCFG=echat,ctnet@mycdma.cn,vnet.mobi";
//u8 *ucZTTS_Abell                = "AT+ZTTS=1,\"276b07687F5EDF57F95BB28B3A67\"";欧标广域对讲机
u8 *ucZTTS_Abell                = "AT+ZTTS=1,\"2d4e745113663d6d20007f5edf57f95bb28b\"";
u8 *ucPocOpenConfig             = "0000000101";
//u8 *ucPocOpenConfig             = "00000001010101";//双全工

void Task_RunStart(void)
{
  UART3_ToMcuMain();
  if(BootProcess_SIMST_Flag==1)//收到模块开机指令:SIMST:1
  {
    api_disp_icoid_output( eICO_IDRXNULL, TRUE, TRUE);//GPRS无信号图标
    
    BEEP_Time(50);
    
    NoUseNum=ApiAtCmd_WritCommand(ATCOMM7_VGR,(u8 *)ucCLVL,strlen((char const *)ucCLVL));//
    Delay_100ms(1);//0.1s
    NoUseNum=ApiAtCmd_WritCommand(ATCOMM7_VGR,(u8 *)ucVGR,strlen((char const *)ucVGR));//
    Delay_100ms(1);//0.1s
    NoUseNum=ApiAtCmd_WritCommand(ATCOMM5_CODECCTL,(u8 *)ucCODECCTL,strlen((char const *)ucCODECCTL));//
    Delay_100ms(1);//0.1s
    NoUseNum=ApiAtCmd_WritCommand(ATCOMM0_OSSYSHWID,(u8 *)ucOSSYSHWID,strlen((char const *)ucOSSYSHWID));//
    Delay_100ms(1);//0.1s
    NoUseNum=ApiAtCmd_WritCommand(ATCOMM4_GD83Mode,(u8 *)ucPrefmode4,strlen((char const *)ucPrefmode4));//
    Delay_100ms(1);//0.1s
    NoUseNum=ApiAtCmd_WritCommand(ATCOMM2_ZTTS_Abell,(u8 *)ucZTTS_Abell,strlen((char const *)ucZTTS_Abell));//播报游标广域对讲机
    api_lcd_pwr_on_hint("中兴易洽广域对讲");
      //api_lcd_pwr_on_hint("中1 b c 广域对讲");
    Delay_100ms(25);//2.5s
    NoUseNum=ApiAtCmd_WritCommand(ATCOMM1_PPPCFG,(u8 *)ucPPPCFG,strlen((char const *)ucPPPCFG));//1.发送PPPCFG
    BootProcess_SIMST_Flag=0;
    VOICE_SetOutput(ATVOICE_FreePlay,"1c64227d517fdc7e",16);//播报搜索网络
    //DEL_SetTimer(0,100);
    //while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
    api_lcd_pwr_on_hint("   搜索网络...  ");
    NoUseNum=ApiAtCmd_WritCommand(ATCOMM6_CSQ,(u8 *)ucCSQ,strlen((char const *)ucCSQ));//CSQ?
    //Delay_100ms(100);//0.1s
    //DEL_SetTimer(0,100);
    //while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
  }
  else
  {
    if(BootProcess_SIMST_Flag==2)
    {
      VOICE_SetOutput(ATVOICE_FreePlay,"c0680d4e30526153",16);//播报检不到卡
      api_lcd_pwr_on_hint("    检不到卡    ");
      Delay_100ms(100);//10s
    }
  }
  if(CSQ_Flag==1)//CSQ?
  {
    api_disp_icoid_output( eICO_IDRXFULL, TRUE, TRUE);//GPRS三格信号图标
    api_disp_icoid_output( eICO_IDEmergency, TRUE, TRUE);//开机搜到信号，显示3G图标
    api_lcd_pwr_on_hint("   正在登陆..     ");
    if(BootProcess_PPPCFG_Flag_Zanshi==1)//如果收到^PPPCFG//因为有时收不到该指令，临时屏蔽，后期加上
    {
      Delay_100ms(10);//1s
      ApiPocCmd_WritCommand(PocComm_SetParam,ucPocOpenConfig,strlen((char const *)ucPocOpenConfig));//配置echat账号、IP
      Delay_100ms(40);//4s
      VOICE_SetOutput(ATVOICE_FreePlay,"636b28577b764696",16);//播报正在登陆 
     api_lcd_pwr_on_hint("   正在登陆...    ");
    //  Delay_100ms(10);//1s
      ApiPocCmd_WritCommand(PocComm_OpenPOC,ucPocOpenConfig,strlen((char const *)ucPocOpenConfig));
      BootProcess_PPPCFG_Flag_Zanshi=0;
      Task_Landing_Flag=TRUE;
    }
  }
  else
  {
    if(CSQ_Flag==2)
    {
      Delay_100ms(50);//5s
      VOICE_SetOutput(ATVOICE_FreePlay,"1c64227d517fdc7e",16);//播报搜索网络
      api_lcd_pwr_on_hint("   搜索网络...  ");
      NoUseNum=ApiAtCmd_WritCommand(ATCOMM6_CSQ,(u8 *)ucCSQ,strlen((char const *)ucCSQ));//CSQ?
    }
  }
}

void Task_RunNormalOperation(void)
{
  Keyboard_Test();
  UART3_ToMcuMain();
/***********PTT状态检测*************************************************************************************************************************/
  if(ReadInput_KEY_PTT==0)//判断按下PTT的瞬间
  {
    AUDIO_IOAFPOW(ON);//打开功放，解决DIDI提示音听不见
    EnterPttMomentCount++;
    if(EnterPttMomentCount==1)
      EnterPttMoment_Flag=TRUE;
    else
    {
      EnterPttMoment_Flag=FALSE;
      EnterPttMomentCount=3;
    }
    LoosenPttMoment_Flag=FALSE;
    LoosenPttMomentCount=0;
  }
  else
  {
    EnterPttMomentCount=0;
    EnterPttMoment_Flag=FALSE;
    LoosenPttMomentCount++;
    if(LoosenPttMomentCount==1)
      LoosenPttMoment_Flag=TRUE;
    else
    {
      LoosenPttMoment_Flag=FALSE;
      LoosenPttMomentCount=3;
    }
  }
//解决写频时，影响其他机器使用（其他机器处于接收状态）
  if(WriteFreq_Flag==TRUE)//解决写频时，群组内其他机器一直有滴滴滴的声音
  {
    ApiPocCmd_WritCommand(PocComm_EndPTT,ucEndPTT,strlen((char const *)ucEndPTT));
  }
//解决换组或个呼是，按住PTT进入死循环收不到指令的问题
  
  if(KeyDownUpChoose_GroupOrUser_Flag==3)
  {KeyDownUpChoose_GroupOrUser_Flag=0;}
    /*if(KeyDownUpChoose_GroupOrUser_Flag==3)
  {
    if(POC_ReceivedVoice_forPTT_Flag==TRUE)
    {
      if(POC_ReceivedVoice_Flag==FALSE)
      {
        POC_ReceivedVoice_Flag=FALSE;
        POC_ReceivedVoice_forPTT_Flag=FALSE;
        KeyDownUpChoose_GroupOrUser_Flag=0;
      }
    }*/
   /* else//否则没收到8300时，过2s自行进入默认状态
    {
      if(EnterKeyTime_2s_Flag==TRUE)
      {
        EnterKeyTime_2s_Flag=FALSE;
        POC_ReceivedVoice_Flag=FALSE;
        POC_ReceivedVoice_forPTT_Flag=FALSE;
        KeyDownUpChoose_GroupOrUser_Flag=0;
      }
    }
  }*/
  switch(KeyPttState)//KeyPttState 0：未按PTT 1:按下ptt瞬间  2：按住PTT状态 3：松开PTT瞬间
  {
  case 0://未按PTT
    POC_ReceivedVoiceEndForXTSF_Flag=0;
    if(KeyDownUpChoose_GroupOrUser_Flag==0)
    {
      if(POC_ReceivedVoice_Flag==TRUE)//解决对方说话时按PTT接收语音异常的问题
      {
        if(EnterPttMoment_Flag==TRUE)
        {
          VOICE_SetOutput(ATVOICE_FreePlay,"8179d153",8);//禁发
        }
      }
      else
      {
        if(WriteFreq_Flag==FALSE)//解决写频时，群组内其他机器一直有滴滴滴的声音
        {
          if(EnterPttMoment_Flag==TRUE)
          {
            ApiPocCmd_WritCommand(PocComm_StartPTT,ucStartPTT,strlen((char const *)ucStartPTT));
          }
        }
      }
    }

    break;
  case 1://1:按下ptt瞬间
    KeyPttState=2;
    break;
  case 2://2：按住PTT状态
    if(POC_ReceivedVoice_Flag==TRUE)//如果正在接受语音
    {
    }
    else
    {
      //解决禁发时间到时，播报“系统释放”，机器已停止发射。但显示屏发射符号不消失，红色指示灯不熄灭
      if(POC_ReceivedVoiceEndForXTSF_Flag==2)
      {
        Set_RedLed(LED_OFF);
        KeyDownUpChoose_GroupOrUser_Flag=3;
      }
      else
      {
        Set_RedLed(LED_ON);
        Set_GreenLed(LED_OFF);
      if(TheMenuLayer_Flag!=0)//解决主呼时影响菜单界面信息显示，现在只要按PTT就会退出菜单
      {
        MenuDisplay(Menu_RefreshAllIco);
        api_lcd_pwr_on_hint("                ");//清屏
        api_lcd_pwr_on_hint(HexToChar_MainGroupId());//显示当前群组ID
        api_lcd_pwr_on_hint4(UnicodeForGbk_MainWorkName());//显示当前群组昵称
        MenuModeCount=1;
        TheMenuLayer_Flag=0;
        MenuMode_Flag=0;
        ApiMenu_SwitchGroup_Flag=0;
        ApiMenu_SwitchCallUser_Flag=0;
        ApiMenu_GpsInfo_Flag=0;
        ApiMenu_BacklightTimeSet_Flag=0;
        ApiMenu_KeylockTimeSet_Flag=0;
        ApiMenu_NativeInfo_Flag=0;
        ApiMenu_BeiDouOrWritingFrequency_Flag=0;
      }
      api_disp_icoid_output( eICO_IDTX, TRUE, TRUE);//发射信号图标
      api_disp_all_screen_refresh();// 全屏统一刷新
      }
    }
    if(LoosenPttMoment_Flag==TRUE)//如果松开PTT瞬间，发送endPTT指令
    {
      ApiPocCmd_WritCommand(PocComm_EndPTT,ucEndPTT,strlen((char const *)ucEndPTT));
    }
    break;
  case 3://3：松开PTT瞬间
    POC_ReceivedVoiceEndForXTSF_Flag=0;
    KeyPttState=0;
    api_disp_icoid_output( eICO_IDTALKAR, TRUE, TRUE);//默认无发射无接收信号图标
    api_disp_all_screen_refresh();// 全屏统一刷新
    break;
  default:
    break;
  }
  
  if(ReadInput_KEY_PTT==0)
  {
    switch(KeyDownUpChoose_GroupOrUser_Flag)
    {
    case 0://默认PTT状态
      break;
    case 1://=1，进入某群组
      VOICE_SetOutput(ATVOICE_FreePlay,"f25d09902d4e",12);//播报已选中
      DEL_SetTimer(0,100);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
      ApiPocCmd_WritCommand(PocComm_EnterGroup,ucPocOpenConfig,strlen((char const *)ucPocOpenConfig));
      KeyDownUpChoose_GroupOrUser_Flag=3;
      EnterKeyTimeCount=0;
      KeyUpDownCount=0;
      break;
    case 2://=2,呼叫某用户
      if(GettheOnlineMembersDone==TRUE)
      {
        //GettheOnlineMembersDone=FALSE;
        VOICE_SetOutput(ATVOICE_FreePlay,"f25d09902d4e",12);//播报已选中
        DEL_SetTimer(0,100);
        while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
        ApiPocCmd_WritCommand(PocComm_Invite,ucPocOpenConfig,strlen((char const *)ucPocOpenConfig));
        KeyDownUpChoose_GroupOrUser_Flag=3;
        TASK_Ptt_StartPersonCalling_Flag=TRUE;//判断主动单呼状态（0a）
        EnterKeyTimeCount=0;
      }
      break;
    case 3:
      break;
    case 4:
      break;
    default:
      break;
    }

    
    
    
  }
  else
  {
    Set_RedLed(LED_OFF);

  }
/*******组呼键状态检测***********************************************************************************************************************************/
  if(ReadInput_KEY_3==0)//组呼键
  {
    if(GetPersonalCallingMode()==1)//如果是单呼模式，则退出单呼
    {
      api_lcd_pwr_on_hint("    退出单呼    ");
      Delay_100ms(5);
      ApiPocCmd_WritCommand(PocComm_Cancel,(u8 *)ucQuitPersonalCalling,strlen((char const *)ucQuitPersonalCalling));
      api_lcd_pwr_on_hint("群组:   组呼模式");
    }
    else
    {
      //当前用户：
      api_lcd_pwr_on_hint("                ");//显示当前群组昵称
      api_lcd_pwr_on_hint4(Get_GBK_ActiveUserID());//显示当前用户名
      VOICE_SetOutput(ATVOICE_FreePlay,Get_Unicode_ActiveUserID(),strlen((char const *)Get_Unicode_ActiveUserID()));//播报当前用户手机号
      
      DEL_SetTimer(0,350);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
      //当前群组
      api_lcd_pwr_on_hint("                ");//显示当前群组昵称
      api_lcd_pwr_on_hint(HexToChar_MainGroupId());//显示当前群组ID
      api_lcd_pwr_on_hint4(UnicodeForGbk_MainWorkName());//显示当前群组昵称
      VOICE_SetOutput(ATVOICE_FreePlay,ApiAtCmd_GetMainWorkName(),strlen((char const *)ApiAtCmd_GetMainWorkName()));
      DEL_SetTimer(0,200);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
      //电量播报
      KeyBatteryReport();
      DEL_SetTimer(0,200);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
        /*群组名：
          电池电量：
            在线人数：*/
      /*api_lcd_pwr_on_hint("                ");//显示当前群组昵称
      api_lcd_pwr_on_hint(HexToChar_MainGroupId());//显示当前群组ID
      api_lcd_pwr_on_hint4(UnicodeForGbk_MainWorkName());//显示当前群组昵称
    
      Key_PersonalCalling_Flag=0;
      VOICE_SetOutput(ATVOICE_FreePlay,"31003900380030003000330030003700340037003200",44);//当前群组
      //VOICE_SetOutput(ATVOICE_FreePlay,"535f4d52A47FC47E",16);//当前群组
      DEL_SetTimer(0,350);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
      //VOICE_SetOutput(ATVOICE_FreePlay,ApiAtCmd_GetMainWorkName(),ApiAtCmd_GetMainWorkNameLen());
      VOICE_SetOutput(ATVOICE_FreePlay,ApiAtCmd_GetMainWorkName(),strlen((char const *)ApiAtCmd_GetMainWorkName()));
      // VOICE_SetOutput(ATVOICE_FreePlay,"13663d6d4b6dd58bc47e3100",strlen((char const *)"13663d6d4b6dd58bc47e3100"));
      */
    }
  }
/*******个呼键状态检测***************************************************************************************************************************************/
  if(ReadInput_KEY_2==0)//个呼键
  {
    api_lcd_pwr_on_hint("对象:   选择个呼");
    api_lcd_pwr_on_hint2(HexToChar_MainUserId());
    PersonalCallingNum=0;//解决按单呼键直接选中，单呼用户并不是播报的用户
    KeyCount_PersonalCalling++;
    
    if(KeyCount_PersonalCalling>=2)
    {
      Key_PersonalCalling_Flag=1;
      VOICE_SetOutput(ATVOICE_FreePlay,"2a4e7c542000106258540990e962",28);//个呼成员选择
      DEL_SetTimer(0,200);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
      KeyCount_PersonalCalling=1;
    }
    ApiPocCmd_WritCommand(PocComm_UserListInfo,ucRequestUserListInfo,strlen((char const *)ucRequestUserListInfo));
    //VOICE_SetOutput(ATVOICE_FreePlay,ApiAtCmd_GetUserName(0),ApiAtCmd_GetUserNameLen(0));
    KeyDownUpChoose_GroupOrUser_Flag=2;
  }
/*******报警键状态检测********************************************************************************************************************************************/
  if(ReadInput_KEY_4==0)//报警键
  {
    switch(AlarmCount)
    {
    case 4://切换为2G模式
      NetworkType_2Gor3G_Flag=2;
      VOICE_SetOutput(ATVOICE_FreePlay,"517fdc7e075262633a4e32004700216a0f5f",36);//网络切换为2G模式
      api_disp_icoid_output( eICO_IDPOWERL, TRUE, TRUE);//图标：2G
      api_disp_all_screen_refresh();// 全屏统一刷新
      DEL_SetTimer(0,200);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
      NoUseNum=ApiAtCmd_WritCommand(ATCOMM4_GD83Mode,(u8 *)ucPrefmode2,strlen((char const *)ucPrefmode2));//
      AlarmCount=8;
      break;
    /*case 2://切换为自动模式
      VOICE_SetOutput(ATVOICE_FreePlay,"517fdc7e075262633a4eea81a852216a0f5f",36);//网络切换为自动模式
      DEL_SetTimer(0,200);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
      NoUseNum=ApiAtCmd_WritCommand(ATCOMM4_GD83Mode,(u8 *)ucPrefmode8,strlen((char const *)ucPrefmode8));//
      AlarmCount=8;
      break;*/
    case 8://切换为3G模式
      NetworkType_2Gor3G_Flag=3;
      VOICE_SetOutput(ATVOICE_FreePlay,"517fdc7e075262633a4e33004700216a0f5f",36);//网络切换为3G模式
      api_disp_icoid_output( eICO_IDEmergency, TRUE, TRUE);//图标：3G
      api_disp_all_screen_refresh();// 全屏统一刷新
      DEL_SetTimer(0,200);
      while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
      NoUseNum=ApiAtCmd_WritCommand(ATCOMM4_GD83Mode,(u8 *)ucPrefmode4,strlen((char const *)ucPrefmode4));//
      AlarmCount=4;
      break;
    default:
      break;
    }
  }
  
/***********判断正常进组；正常退出组;被单呼模式；退出单呼模式；主动开始单呼；单呼；主动退出单呼*********************************************************************************************************************/
if(POC_EnterPersonalCalling_Flag==2)//如果是被单呼
{
  MenuDisplay(Menu_RefreshAllIco);
  api_lcd_pwr_on_hint("                ");//清屏
  api_lcd_pwr_on_hint(HexToChar_MainUserId());//显示当前群组ID
  api_lcd_pwr_on_hint4(UnicodeForGbk_MainUserName());//显示当前用户昵称
  api_disp_icoid_output( eICO_IDPOWERH, TRUE, TRUE);//显示个呼图标
  PersonCallIco_Flag=1;
  api_disp_all_screen_refresh();// 全屏统一刷新
  POC_EnterPersonalCalling_Flag=1;//在单呼模式
}
else//如果是正常进组；组内；正常退出组;单呼；退出单呼模式；
{
      if(POC_EnterPersonalCalling_Flag==0)//如果是正常进组；组内；正常退出组
      {
        if(POC_EnterGroupCalling_Flag==2)//正在进入群组、进入个呼
        {

          if(POC_AtEnterPersonalCalling_Flag==2)//主动开始单呼模式(实际为单呼结束)
          {
            MenuDisplay(Menu_RefreshAllIco);
            api_lcd_pwr_on_hint("                ");//清屏
            api_disp_icoid_output( eICO_IDPOWERH, TRUE, TRUE);//显示个呼图标
            api_lcd_pwr_on_hint(HexToChar_MainUserId());//显示当前用户ID
            api_lcd_pwr_on_hint4(UnicodeForGbk_MainUserName());//显示当前用户昵称
            PersonCallIco_Flag=1;
            api_disp_all_screen_refresh();// 全屏统一刷新//可能会对POC开机PoC指令识别有影响
            POC_AtEnterPersonalCalling_Flag=1;
          }
          else
          {
            if(POC_AtEnterPersonalCalling_Flag==1)
            {
            }
            else
            {
              MenuDisplay(Menu_RefreshAllIco);
              api_lcd_pwr_on_hint("                ");//清屏
              api_disp_icoid_output( eICO_IDPOWERM, TRUE, TRUE);//显示组呼图标
              api_disp_icoid_output( BatteryLevel, TRUE, TRUE);
              api_lcd_pwr_on_hint(HexToChar_MainGroupId());//显示当前群组ID
              api_lcd_pwr_on_hint4(UnicodeForGbk_MainWorkName());//显示当前群组昵称
              PersonCallIco_Flag=0;
              api_disp_all_screen_refresh();// 全屏统一刷新//可能会对POC开机PoC指令识别有影响
            }
          }
          POC_EnterGroupCalling_Flag=1;
          
        }
        else if(POC_EnterGroupCalling_Flag==1)//组内
        {
        }
        else//退出组别
        {
          if(POC_QuitGroupCalling_Flag==2)
          {
              MenuDisplay(Menu_RefreshAllIco);
              api_lcd_pwr_on_hint("                ");//清屏
              api_disp_icoid_output( eICO_IDPOWERM, TRUE, TRUE);//显示组呼图标
              api_lcd_pwr_on_hint(HexToChar_MainGroupId());//显示当前群组ID
              api_lcd_pwr_on_hint4(UnicodeForGbk_MainWorkName());//显示当前群组昵称
              PersonCallIco_Flag=0;
              api_disp_all_screen_refresh();// 全屏统一刷新//可能会对POC开机PoC指令识别有影响
              POC_QuitGroupCalling_Flag=1;
          }

        }
      }
      else//单呼模式；退出单呼模式；
      {
        if(POC_QuitPersonalCalling_Flag==2)//如果是退出单呼模式----------------------------
        {
          POC_QuitPersonalCalling_Flag=0;
          //退出单呼无需处理，进入群组处理 
        }
        else//单呼模式
        {

        }
      }
}

/*********判断发射接收图标状态****************************************************************************************************************************/
if(PersonCallIco_Flag==1)
{
  if(POC_ReceivedVoiceStart_Flag==2)//刚接收语音状态
  {
    api_disp_icoid_output( eICO_IDVOX, TRUE, TRUE);//接收信号图标
    api_disp_all_screen_refresh();// 全屏统一刷新
    POC_ReceivedVoiceStart_Flag=1;//接收语音状态
  }
  else//0空闲状态；1接收状态
  {
    if(POC_ReceivedVoiceEnd_Flag==2)//空闲状态
    {
      api_disp_icoid_output( eICO_IDTALKAR, TRUE, TRUE);//默认无发射无接收信号图标
      api_disp_all_screen_refresh();// 全屏统一刷新
      POC_ReceivedVoiceEnd_Flag=0;//默认无语音状态
    }
    else//空闲状态
    {}
  }
}
else
{
  if(POC_ReceivedVoiceStart_Flag==2)//刚接收语音状态
  {
    api_lcd_pwr_on_hint("                ");//清屏
    api_lcd_pwr_on_hint4(UnicodeForGbk_SpeakerRightnowName());//显示当前说话人的昵称
    POC_ReceivedVoiceStart_Flag=1;//接收语音状态
    //修复BUG： A机换组状态，B机呼A机后，A机按PTT却是换组（被呼后A机应该返回默认状态：）
    KeyDownUpChoose_GroupOrUser_Flag=0;
    KeyUpDownCount=0;
    //修复BUG：在菜单界面，B机呼A机，显示屏显示混乱的问题（现为被呼A机退出菜单）
    if(TheMenuLayer_Flag!=0)
    {
      MenuDisplay(Menu_RefreshAllIco);
      MenuModeCount=1;
      TheMenuLayer_Flag=0;
      MenuMode_Flag=0;
      ApiMenu_SwitchGroup_Flag=0;
      ApiMenu_SwitchCallUser_Flag=0;
      ApiMenu_GpsInfo_Flag=0;
      ApiMenu_BacklightTimeSet_Flag=0;
      ApiMenu_KeylockTimeSet_Flag=0;
      ApiMenu_NativeInfo_Flag=0;
      ApiMenu_BeiDouOrWritingFrequency_Flag=0;
    }
    api_disp_icoid_output( eICO_IDVOX, TRUE, TRUE);//接收信号图标
    api_disp_all_screen_refresh();// 全屏统一刷新

  }
  else//0空闲状态；1接收状态
  {
    if(POC_ReceivedVoiceEnd_Flag==2)//空闲状态
    {
    api_disp_icoid_output( eICO_IDTALKAR, TRUE, TRUE);//默认无发射无接收信号图标
    api_lcd_pwr_on_hint("                ");//清屏
    api_lcd_pwr_on_hint(HexToChar_MainGroupId());//显示当前群组ID
    api_lcd_pwr_on_hint4(UnicodeForGbk_MainWorkName());//显示当前群组昵称
    api_disp_all_screen_refresh();// 全屏统一刷新
    POC_ReceivedVoiceEnd_Flag=0;//默认无语音状态
    Key_PersonalCalling_Flag=0;//解决被结束单呼后，按上下键任然是切换个呼成员
    }
  else//空闲状态
  {}
  }
}


/********控制功放喇叭*************************************/
if(ApiPocCmd_Tone_Flag==TRUE)//8b0003 解决按PTT无提示音的问题
{
  AUDIO_IOAFPOW(ON);
}
else
{
  if(ApiAtCmd_TrumpetVoicePlay_Flag==TRUE)
  {
    AUDIO_IOAFPOW(ON);//在VOICE_SetOutput()加了打开，在识别POC:91加了功放打开;PTT键
  }
  else
  {
    AUDIO_IOAFPOW(OFF);
  }
  
}

/***********************************************/

}
void TASK_WriteFreq(void)
{
  UART3_ToMcuMain();
}
void TASK_RunLoBattery(void)
{
  api_lcd_pwr_on_hint(" 电量低  请充电  ");
  VOICE_SetOutput(ATVOICE_FreePlay,"3575606c3575cf914e4f0cfff78b73513a6745513575",44);//群组选择
  DEL_SetTimer(0,1000);
  while(1){if(DEL_GetTimer(0) == TRUE) {break;}}
  BEEP_Time(10);
}
void Delay_100ms(u8 T)
{
  u16 i;
  u8 j,k,l;
    for(j = 0; j < 83; j++)
    for(l = 0; l < 10; l++)
        for(k = 0; k < 100; k++)
          for(i = 0; i < T; i++)
      {
        nop();
      }
  return;
}

